---
type Filter = 'all' | 'active' | 'completed';

type TodoItem = {
  id: number;
  text: string;
  completed: boolean;
};

const initialTodos: TodoItem[] = [
  { id: 1, text: 'Draft component API', completed: true },
  { id: 2, text: 'Build directive tests', completed: false }
];
const initialFilter = 'all' as Filter;

const activeTodos = initialTodos.filter((todo) => !todo.completed);
const completedTodos = initialTodos.filter((todo) => todo.completed);

const filteredTodos =
  initialFilter === 'active'
    ? activeTodos
    : initialFilter === 'completed'
      ? completedTodos
      : initialTodos;

const emptyMessage =
  initialFilter === 'active'
    ? 'No active todos.'
    : initialFilter === 'completed'
      ? 'No completed todos.'
      : 'No todos yet.';

const initialData = { todos: initialTodos, filter: initialFilter };
const canAdd = false;
const activeNoun = activeTodos.length === 1 ? 'item' : 'items';
---
<todo-nanostores x-cloak data-initial={JSON.stringify(initialData)}>
      <h1>üìù Todo App ‚Äî Astro</h1>

      <div class="add-todo">
        <input
          x-ref="input"
          type="text"
          x-prop:value="$newTodo"
          x-on:input="onInput($event)"
          placeholder="What needs to be done?">
        <button class="btn-add" x-on:click="addTodo()" x-prop:disabled="!$canAdd" disabled={!canAdd}>
          Add
        </button>
      </div>

      <div class="filters">
        <button
          class={`filter-btn${initialFilter === 'all' ? ' active' : ''}`}
          x-class:active="$filter === 'all'"
          x-on:click="setFilter('all')">
          All (<span x-text="$todos.length">{initialTodos.length}</span>)
        </button>
        <button
          class={`filter-btn${initialFilter === 'active' ? ' active' : ''}`}
          x-class:active="$filter === 'active'"
          x-on:click="setFilter('active')">
          Active (<span x-text="$activeTodos.length">{activeTodos.length}</span>)
        </button>
        <button
          class={`filter-btn${initialFilter === 'completed' ? ' active' : ''}`}
          x-class:active="$filter === 'completed'"
          x-on:click="setFilter('completed')">
          Completed (<span x-text="$completedTodos.length">{completedTodos.length}</span>)
        </button>
      </div>

      <template x-if="$filteredTodos.length === 0">
        <div class="empty-state">
          <p x-text="$emptyMessage">{emptyMessage}</p>
        </div>
      </template>

      <ul class="todos" x-show="$filteredTodos.length > 0">
        <template x-for="todo in $filteredTodos" x-key="todo.id">
          <li class="todo-item">
            <input
              type="checkbox"
              class="todo-checkbox"
              x-prop:checked="todo.completed"
              x-on:change="toggleTodo(todo.id)">
            <span class="todo-text" x-text="todo.text" x-class:completed="todo.completed"></span>
            <button class="btn-delete" x-on:click="deleteTodo(todo.id)">
              Delete
            </button>
          </li>
        </template>
        {filteredTodos.map((todo) => (
          <li class="todo-item">
            <input
              type="checkbox"
              class="todo-checkbox"
              checked={todo.completed}
              x-prop:checked="todo.completed"
              x-on:change={`toggleTodo(${todo.id})`}>
            <span
              class={`todo-text${todo.completed ? ' completed' : ''}`}
              x-text="todo.text"
              x-class:completed="todo.completed">
              {todo.text}
            </span>
            <button class="btn-delete" x-on:click={`deleteTodo(${todo.id})`}>
              Delete
            </button>
          </li>
        ))}
      </ul>

      <div class="stats" x-show="$todos.length > 0">
        <span>
          <span x-text="$activeTodos.length">{activeTodos.length}</span>
          <span x-text="$activeTodos.length === 1 ? 'item' : 'items'">{activeNoun}</span>
          left
        </span>
        <button
          x-show="$completedTodos.length > 0"
          x-on:click="clearCompleted()"
          style="background: transparent; color: #999; padding: 0;">
          Clear completed
        </button>
      </div>
    </todo-nanostores>

<script>
    import { atom, computed } from 'nanostores';
    import { defineComponent, registerAdapter } from '../../../../src/index';
    import { nanostoresAdapter } from '../../../../src/adapters/nanostores';

    registerAdapter(nanostoresAdapter, { replace: true });

    type Filter = 'all' | 'active' | 'completed';

    type TodoItem = {
      id: number;
      text: string;
      completed: boolean;
    };

    type InitialData = {
      todos: TodoItem[];
      filter: Filter;
    };

    const DEFAULT_TODOS: TodoItem[] = [
      { id: 1, text: 'Draft component API', completed: true },
      { id: 2, text: 'Build directive tests', completed: false }
    ];

    const parseInitial = (value?: string) => {
      if (!value) return null;
      try {
        return JSON.parse(value) as InitialData;
      } catch {
        return null;
      }
    };

    defineComponent('todo-nanostores', (ctx) => {
      const initial = parseInitial(ctx.host.dataset.initial);
      const $todos = atom<TodoItem[]>(initial?.todos ?? DEFAULT_TODOS);
      const $newTodo = atom('');
      const $filter = atom<Filter>(initial?.filter ?? 'all');

      const $activeTodos = computed($todos, (todos) => todos.filter((todo) => !todo.completed));
      const $completedTodos = computed($todos, (todos) => todos.filter((todo) => todo.completed));
      const $filteredTodos = computed([$todos, $filter], (todos, filter) => {
        if (filter === 'active') return todos.filter((todo) => !todo.completed);
        if (filter === 'completed') return todos.filter((todo) => todo.completed);
        return todos;
      });
      const $canAdd = computed($newTodo, (value) => value.trim().length > 0);
      const $emptyMessage = computed($filter, (filter) => {
        if (filter === 'active') return 'No active todos.';
        if (filter === 'completed') return 'No completed todos.';
        return 'No todos yet.';
      });

      const onInput = (event: Event) => {
        const target = event.target as HTMLInputElement | null;
        $newTodo.set(target?.value ?? '');
      };

      const addTodo = () => {
        const text = $newTodo.get().trim();
        if (!text) return;
        $todos.set([...$todos.get(), { id: Date.now(), text, completed: false }]);
        $newTodo.set('');
        ctx.$refs.input?.focus();
      };

      ctx.on(ctx.$refs.input, 'keydown', (event: KeyboardEvent) => {
        if (event.key === 'Enter') {
          addTodo();
        }
      });

      const toggleTodo = (id: number) => {
        $todos.set(
          $todos.get().map((todo) => (todo.id === id ? { ...todo, completed: !todo.completed } : todo))
        );
      };

      const deleteTodo = (id: number) => {
        $todos.set($todos.get().filter((todo) => todo.id !== id));
      };

      const clearCompleted = () => {
        $todos.set($todos.get().filter((todo) => !todo.completed));
      };

      const setFilter = (next: Filter) => {
        $filter.set(next);
      };

      return {
        $todos,
        $newTodo,
        $filter,
        $activeTodos,
        $completedTodos,
        $filteredTodos,
        $canAdd,
        $emptyMessage,
        onInput,
        addTodo,
        toggleTodo,
        deleteTodo,
        clearCompleted,
        setFilter
      };
    });
  </script>
  <style>
    h1 {
      margin-bottom: 1.5rem;
      color: #333;
    }

    .add-todo {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }

    input[type="text"] {
      flex: 1;
      padding: 0.75rem;
      border: 2px solid #ddd;
      border-radius: 4px;
      font-size: 1rem;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #e91e63;
    }

    button {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-add {
      background: #e91e63;
      color: white;
    }

    .btn-add:hover {
      background: #c2185b;
    }

    .btn-add:disabled {
      background: #ccc;
      cursor: not-allowed;
    }

    .filters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #eee;
    }

    .filter-btn {
      padding: 0.5rem 1rem;
      background: #f0f0f0;
      color: #666;
    }

    .filter-btn.active {
      background: #e91e63;
      color: white;
    }

    .todos {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .todo-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 1rem;
      border-bottom: 1px solid #eee;
      transition: background 0.2s;
    }

    .todo-item:hover {
      background: #f9f9f9;
    }

    .todo-checkbox {
      width: 20px;
      height: 20px;
      margin: 0;
      cursor: pointer;
    }

    .todo-text {
      flex: 1;
      font-size: 1rem;
    }

    .todo-text.completed {
      text-decoration: line-through;
      color: #999;
    }

    .btn-delete {
      padding: 0.5rem 1rem;
      background: #f44336;
      color: white;
      font-size: 0.875rem;
    }

    .btn-delete:hover {
      background: #da190b;
    }

    .stats {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 2px solid #eee;
      color: #666;
      font-size: 0.875rem;
      display: flex;
      justify-content: space-between;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #999;
    }
  </style>
